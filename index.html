<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFG MOVIES FLAX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    
    <style>
        :root{--primary-color:#6d28d9;--secondary-color:#db2777;--dark-color:#0f172a;--light-dark-color:#1e293b;--text-color:#e2e8f0;--text-muted:#94a3b8}*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Poppins',sans-serif;background-color:var(--dark-color);color:var(--text-color);overflow-x:hidden}header{position:fixed;top:0;left:0;width:100%;display:flex;justify-content:space-between;align-items:center;padding:16px 5%;z-index:100;background:rgba(15,23,42,.5);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.1)}.logo{font-size:1.8rem;font-weight:700;color:#fff;text-shadow:0 0 10px var(--primary-color)}.search-container{border:1px solid var(--light-dark-color);padding:8px 12px;border-radius:50px;display:flex;align-items:center;background:rgba(0,0,0,.2)}#search-input{background:transparent;border:none;color:var(--text-color);outline:none;width:200px;font-size:1rem}#search-input::placeholder{color:var(--text-muted)}.search-container i{color:var(--text-muted)}#hero-section{height:85vh;display:flex;align-items:flex-end;padding:5%;position:relative;background-size:cover;background-position:center top;transition:background-image .5s ease-in-out}#hero-section::before{content:'';position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to top,var(--dark-color) 10%,rgba(15,23,42,.5) 50%,rgba(15,23,42,.2) 100%)}.hero-content{position:relative;z-index:2;max-width:50%;animation:fadeIn 1s ease-out}.hero-content h1{font-size:3.5rem;font-weight:700;line-height:1.1;margin-bottom:16px}.hero-content .category{background-color:rgba(255,255,255,.1);padding:6px 12px;border-radius:50px;font-size:.9rem;display:inline-block;margin-bottom:24px}.hero-btn{padding:14px 32px;border-radius:50px;font-size:1.1rem;font-weight:600;cursor:pointer;border:none;background-image:linear-gradient(to right,var(--primary-color),var(--secondary-color));color:#fff;transition:transform .2s,box-shadow .2s}.hero-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.2)}#movie-grid{padding:0 5%;margin-top:-50px;position:relative;z-index:5}.category-row{margin-bottom:48px}.category-title{font-size:1.5rem;font-weight:600;margin-bottom:16px}.movies-scroll{display:flex;overflow-x:auto;overflow-y:hidden;padding-bottom:20px;gap:16px}.movies-scroll::-webkit-scrollbar{height:8px}.movies-scroll::-webkit-scrollbar-track{background:var(--light-dark-color);border-radius:4px}.movies-scroll::-webkit-scrollbar-thumb{background:var(--primary-color);border-radius:4px}.movie-poster{flex:0 0 180px;height:270px;cursor:pointer;border-radius:12px;overflow:hidden;background-color:var(--light-dark-color);transition:transform .3s ease,box-shadow .3s ease}.movie-poster img{width:100%;height:100%;object-fit:cover}.movie-poster:hover{transform:scale(1.05) translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.3),0 0 20px var(--primary-color)}#details-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);backdrop-filter:blur(10px);z-index:1000;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}#details-overlay.active{opacity:1;visibility:visible}.details-popup{background-color:var(--light-dark-color);border-radius:16px;width:90%;max-width:800px;display:flex;gap:32px;padding:32px;position:relative;transform:scale(.9);transition:transform .3s;border:1px solid rgba(255,255,255,.1)}#details-overlay.active .details-popup{transform:scale(1)}.details-poster img{width:220px;height:330px;object-fit:cover;border-radius:12px}.details-info{display:flex;flex-direction:column}.details-info h2{font-size:2.8rem;margin:0 0 10px}.details-info .category{background-color:#334155;padding:4px 10px;border-radius:50px;font-size:.9rem;align-self:flex-start;margin-bottom:24px}.details-buttons{margin-top:auto;display:flex;gap:16px}.details-buttons .btn{padding:12px 24px;border:none;border-radius:50px;cursor:pointer;font-size:1rem;font-weight:600;display:flex;align-items:center;gap:8px;transition:all .2s}.btn-watch{background-image:linear-gradient(to right,var(--primary-color),var(--secondary-color));color:#fff}.btn-download{background-color:#334155;color:var(--text-color)}.details-buttons .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}.close-popup-btn{position:absolute;top:16px;right:16px;font-size:2rem;cursor:pointer;color:var(--text-muted);transition:color .2s}.close-popup-btn:hover{color:#fff}.hidden{display:none!important}.loader{border:5px solid var(--light-dark-color);border-top:5px solid var(--primary-color);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:100px auto}#movie-player-container{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000;z-index:2000;display:flex;flex-direction:column}.player-header{padding:15px 20px;background-color:#111;display:flex;align-items:center}#player-close-btn{cursor:pointer;font-size:1.2em}#player-movie-title{margin-left:20px;font-size:1.2em}#player-content{flex-grow:1}#player-content iframe{width:100%;height:100%;border:none}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@media (max-width:768px){header{padding:16px 4%}#hero-section{height:70vh}.hero-content{max-width:100%;text-align:center}.hero-content h1{font-size:2.5rem}#movie-grid{padding:0 4%}.details-popup{flex-direction:column;text-align:center;max-height:90vh;overflow-y:auto}.details-poster{align-self:center}.details-poster img{width:150px;height:225px}.details-info .category{align-self:center}.details-info h2{font-size:1.8rem}.details-buttons{margin-top:20px;justify-content:center}}
    </style>
</head>
<body>
    <header>
        <div class="logo">NFG FLIX</div>
        <div class="search-container"><i class="fas fa-search"></i><input type="text" id="search-input" placeholder="Search for movies..."></div>
    </header>
    <section id="hero-section">
        <div class="hero-content">
            <h1 id="hero-title">Loading Movie...</h1>
            <div class="category" id="hero-category">Category</div>
            <button id="hero-watch-btn" class="hero-btn"><i class="fas fa-play"></i> Watch Now</button>
        </div>
    </section>
    <main id="movie-grid"><div id="loader" class="loader"></div></main>
    <div id="details-overlay">
        <div class="details-popup">
            <span class="close-popup-btn" id="close-popup-btn">×</span>
            <div class="details-poster"><img id="popup-poster" src="" alt="Poster"></div>
            <div class="details-info">
                <h2 id="popup-title">Movie Title</h2>
                <span class="category" id="popup-category">Category</span>
                <div class="details-buttons">
                    <button id="popup-watch-btn" class="btn btn-watch"><i class="fas fa-play"></i> Watch Now</button>
                    <button id="popup-download-btn" class="btn btn-download"><i class="fas fa-download"></i> Download</button>
                </div>
            </div>
        </div>
    </div>
    <div id="movie-player-container" class="hidden">
        <div class="player-header">
            <span id="player-close-btn">← Back</span><h3 id="player-movie-title">Movie Title</h3>
        </div>
        <div id="player-content"></div>
    </div>

    <!-- YEH MODULAR SDK HAI -->
    <script type="module">
        // Dekho, yahan 'import' ka use ho raha hai. Yeh Modular SDK ki pehchan hai.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, increment, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // ======================================================================
        // STEP 1: Apna Firebase config yahan paste karo
        const firebaseConfig = {
            apiKey: "AIzaSyCvX-6mAbZfJZ8ogI5xIU05EMRaXO1BxPw",
            authDomain: "nfgflax-ffcfa.firebaseapp.com",
            databaseURL: "https://nfgflax-ffcfa-default-rtdb.firebaseio.com",
            projectId: "nfgflax-ffcfa",
            storageBucket: "nfgflax-ffcfa.firebasestorage.app",
            messagingSenderId: "205692317813",
            appId: "1:205692317813:web:3f4d065819e84748ab483c",
            measurementId: "G-QYJ37K6DZK"
        };
        // ======================================================================
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const mainContent = document.getElementById("movie-grid");
        const loader = document.getElementById("loader");
        const searchInput = document.getElementById("search-input");
        const detailsOverlay = document.getElementById("details-overlay");
        const playerContainer = document.getElementById("movie-player-container");
        
        let allMovies = [];
        let categories = [];

        async function fetchAndDisplayContent() {
            const moviesCollection = collection(db, "movies");
            const q = query(moviesCollection, orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            
            allMovies = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            loader.classList.add("hidden");

            if (allMovies.length === 0) {
                mainContent.innerHTML = '<p style="text-align:center;">Koi movie available nahi hai.</p>';
                document.getElementById("hero-section").style.display = "none";
                return;
            }

            displayFeaturedMovie(allMovies[0]);
            const uniqueCategories = new Set(allMovies.map(movie => movie.category));
            categories = [...uniqueCategories];
            displayMoviesByCategory(allMovies, categories);
        }

        function displayFeaturedMovie(movie) {
            if (!movie) return;
            document.getElementById("hero-section").style.backgroundImage = `url(${movie.posterUrl})`;
            document.getElementById("hero-title").textContent = movie.title;
            document.getElementById("hero-category").textContent = movie.category;
            const watchBtn = document.getElementById("hero-watch-btn");
            watchBtn.onclick = () => {
                openPlayer(movie.watchLink, movie.title);
                incrementStat("views", movie.id);
            };
        }

        function displayMoviesByCategory(movies, categoriesToDisplay) {
            mainContent.innerHTML = "";
            categoriesToDisplay.forEach(category => {
                const moviesInCategory = movies.filter(movie => movie.category === category);
                if (moviesInCategory.length > 0) {
                    const categoryRow = document.createElement("div");
                    categoryRow.className = "category-row";
                    categoryRow.innerHTML = `
                        <h2 class="category-title">${category}</h2>
                        <div class="movies-scroll">
                            ${moviesInCategory.map(movie => `
                                <div class="movie-poster" data-id="${movie.id}">
                                    <img src="${movie.posterUrl}" alt="${movie.title}" loading="lazy" onerror="this.src='https://via.placeholder.com/180x270.png?text=No+Image'">
                                </div>`).join("")}
                        </div>`;
                    mainContent.appendChild(categoryRow);
                }
            });
            
            document.querySelectorAll(".movie-poster").forEach(poster => {
                poster.addEventListener("click", () => showMovieDetails(poster.dataset.id));
            });
        }

        function showMovieDetails(movieId) {
            const movie = allMovies.find(m => m.id === movieId);
            if (!movie) return;

            document.getElementById("popup-poster").src = movie.posterUrl;
            document.getElementById("popup-title").textContent = movie.title;
            document.getElementById("popup-category").textContent = movie.category;

            const watchBtn = document.getElementById("popup-watch-btn");
            const downloadBtn = document.getElementById("popup-download-btn");

            watchBtn.onclick = () => {
                openPlayer(movie.watchLink, movie.title);
                incrementStat("views", movie.id);
                detailsOverlay.classList.remove("active");
            };

            downloadBtn.onclick = () => {
                window.open(movie.downloadLink, "_blank");
                incrementStat("downloads", movie.id);
            };

            detailsOverlay.classList.add("active");
        }

        document.getElementById("close-popup-btn").addEventListener("click", () => detailsOverlay.classList.remove("active"));
        detailsOverlay.addEventListener("click", (e) => {
            if (e.target === detailsOverlay) {
                detailsOverlay.classList.remove("active");
            }
        });

        // ======================================================================
        // === UPDATED FUNCTION YAHA HAI ===
        // Is function ko Google Drive links ko handle karne ke liye aasan bana diya gaya hai
        // ======================================================================
        function openPlayer(watchLink, title) {
            let embedUrl = watchLink; // Default link wahi rakhte hain

            // Check karein ki link Google Drive ka hai ya nahi
            if (watchLink && watchLink.includes("drive.google.com/file")) {
                // Link se File ID nikalte hain
                const parts = watchLink.split('/d/');
                if (parts.length > 1) {
                    const idPart = parts[1].split('/')[0];
                    // Sahi 'preview' (embed) URL banate hain
                    embedUrl = `https://drive.google.com/file/d/${idPart}/preview`;
                }
            }
            
            // Ab player ko dikhayein aur naya (ya purana) embedUrl iframe mein set karein
            playerContainer.classList.remove("hidden");
            document.getElementById("player-movie-title").textContent = title;
            const playerContent = document.getElementById("player-content");
            playerContent.innerHTML = `<iframe src="${embedUrl}" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
        }

        document.getElementById("player-close-btn").onclick = () => {
            playerContainer.classList.add("hidden");
            // Iframe ko hatana zaroori hai taaki video background me na chale
            document.getElementById("player-content").innerHTML = ""; 
        };

        async function incrementStat(statType, movieId) {
            const today = new Date().toISOString().split("T")[0]; // format: YYYY-MM-DD
            // Total stats
            await setDoc(doc(db, "stats", "totals"), { [statType]: increment(1) }, { merge: true });
            // Daily stats
            await setDoc(doc(db, "stats", `daily_${today}`), { [statType]: increment(1) }, { merge: true });
        }

        searchInput.addEventListener("keyup", (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            document.getElementById("hero-section").style.display = searchTerm ? "none" : "flex";

            if (searchTerm.length > 1) {
                const filteredMovies = allMovies.filter(movie => movie.title.toLowerCase().includes(searchTerm));
                const filteredCategories = [...new Set(filteredMovies.map(movie => movie.category))];
                displayMoviesByCategory(filteredMovies, filteredCategories);
            } else if (searchTerm.length === 0) {
                displayMoviesByCategory(allMovies, categories);
            }
        });

        document.addEventListener("DOMContentLoaded", fetchAndDisplayContent);
    </script>
</body>
</html>
